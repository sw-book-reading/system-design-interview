# 14장 유튜브 설계

## 요구사항 정의

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용(infrastructure cost)
- 높은 가용성과 규모 확장성, 그리고 안정성
- 모바일, 웹 브라우저, 스마트TV 지원

<br />
<br />

## 용어 정리

- 메타데이터

  대량의 데이터들 사이에서 찾고자 하는 정보를 효율적으로 찾아내기 위해 일정한 규칙에 의거하여 컨텐츠에 부여해주는 데이터이다.

  ex) DB의 인덱스나 운영체제의 파일시스템 에서의 파일 헤더 같은 것들 ...

- Blob

  Blob은 Binary Large Object의 줄임말이고

  직역하면 이진수로 이루어진 데이터를 담고 있는 큰 객체라는 말인데

  주로 이미지,오디오,비디오 등의 데이터를 관리할 때 쓴다고 한다.

  생각해보면 대부분 용량이 큰 멀티미디어 파일들을 다루기엔 binary로 정보를 전달하는게 더 낫다고 생각한다.

### Blob 인터페이스의 명세

  <img width="822" alt="KakaoTalk_Photo_2023-02-05-20-25-58" src="https://user-images.githubusercontent.com/103870198/216816011-39c6572a-9c96-4b02-96d2-a6d6fc96fc08.png">

출처: https://www.w3.org/TR/FileAPI/#typedefdef-blobpart

- 인코딩/트랜스코딩

  비디오의 포맷을 변환하는 과정을 트랜스코딩이라고 한다.

  - 컨테이너(container)

    비디오 파일 + 오디오 + 메타데이터를 묶은 것

    `.avi`, `mov`, `mp4` 등의 확장자를 통해 컨테이너 포맷을 알 수 있다.

  - 코덱(codec)

    비디오 화질을 보존하면서 파일 크기를 줄이기 위한 압축/해제 알고리즘

    H.264 같은 코덱이 있다.

<br />
<br />

## 개략적 설계도

빠른 재생을 위해 CDN을 통해 서빙하고

메타데이터를 보관해 요청을 빠르게 처리한다.

![ebb894eba19ceab7b82](https://user-images.githubusercontent.com/103870198/216814398-3f9969fd-5519-46ea-bb0d-ece408507e0e.png)

1. 원본 저장소에서 CDN 까지 : 영상 인코딩을 비롯한 가공작업을 거친 뒤 CDN에 최종 영상을 업로드 한다.

2. API 서버에서 메타데이터 캐시/DB 까지 : 1번 흐름이 진행되는 동안 클라이언트는 병렬로 또다른 요청을 서버로 보낸다. 비디오 메타데이터를 업데이트 하는 요청이다.
   또한 비디오 업로드가 완료되면 API 서버가 사용자에게 업로드가 완료되었음을 알린다.

<br />

## 비디오 트랜스코딩 구조

워터마크, 화질 별 서비스 등 여러 기능을 제공해야 하기 때문에 `DAG(Directed Acyclic Graph) 프로그래밍 모델`을 도입한다.

DAG는 실제로 페이스북의 스트리밍 비디오 엔진이 사용한다고 한다.

DAG는 트랜스코딩 작업을 단계별로 배열하여 해당 작업들이 순차적으로 또는 병렬적으로 실행될 수 있게 하는 모델이다.

<br />

## 비디오 처리 아키텍쳐

- 검사 : 좋은 품질의 비디오인지, 손상은 없는지 확인
- 비디오 인코딩 : 비디오를 다양한 해상도,코덱, 비트레이트 조합으로 인코딩하는 작업
- 썸네일 추출 : 사용자가 업로드한 이미지나 비디오에서 자동으로 썸네일 추출
- 워터마크 : 비디오에 대한 식별정로를 오버레이 형태로 띄워 표시

위 작업이 이루어지는 파이프라인의 과정이다.

1. 전처리기

   - DAG 생성
     - 검사, 썸네일 추출, 워터마크 등의 작업 중 어떤 것을 수행해야 하는지와 수행 순서 등을 받아 DAG를 만든다.
   - 데이터 캐시
     - 안정성을 위해 GOP와 메타데이터를 임시 저장소에 보관한다.
   - 비디오 분할
     - 비디오 스트림을 GOP 단위로 쪼갠다, 원래 단말이나 브라우저가 하는건데 지원 안하는 경우에만 전처리기가 담당

2. DAG 스케줄러

   - 각 스텝을 자원 관리자의 작업 큐에 집어넣는다.

3. 자원 관리자

   - 현재 상황을 보고 어떤 작업을 수행해야 가장 효율적일지를 결정하여 작업 서버에게 넘겨준다.

   - 자원 관리자는 3개의 큐와 스케줄러로 구성된다.
     스케줄러는 아래 3개의 큐를 보고 최적의 작업 +서버 조합을 골라 넘겨 준다.

     - 작업 큐 : DAG 스케줄러가 넘겨주는 작업이 들어있는 우선 순위 큐
     - 작업 서버 큐 : 작업 서버의 가용 상태가 들어있는 우선 순위 큐
     - 실행 큐 : 현재 실행중인 작업과 작업 서버 정보가 들어있는 큐

4. 작업 실행 서버

   - DAG에 정의한 작업을 수행한다.

5. 임시 저장소

   - 작업 서버의 프로세스가 실패한 경우를 대비하고, 빠른 작업 속도를 위해 임시로 데이터를 저장한다.

6. 인코딩 비디오

   - 위 모든 과정의 최종 결과물이다.

마지막으로 비동기 처리로 인코딩을 빠르게 하고

병렬 업로드를, 업로드 센터를 물리적으로 가까운곳에 위치시키기, 모든 절차를 병렬화 시켜서 최적화 한다.

<br />
<br />

## 빠른 접근을 위한 상세 설계

<br />

### 메타데이터

메타데이터를 통해 영상에 빠르게 접근 가능,

메타데이터는 주로 파일 이름, 크기 , 포맷 등의 정보가 들어간다.

<br />

### CDN & 여러 화질로 인코딩

CDN을 통해 영상을 빠르게 서빙한다.

영상을 여러 화질로 인코딩해두어 사용자의 네트워크 상황에 따라 화질을 조절해 속도를 보장한다.

<br />
<br />

## 기타 최적화

<br />

### 안정성 최적화 : 미리 사인된 업로드 URL

허가받은자만 비디오를 업로드할 수 있도록 미리 사인된 업로드 URL을 이용한다.

1. 클라이언트는 HTTP 서버에 요청하여 미리 사인된 업로드 URL을 요청 한다.
   - 아마존 S3는 `미리 사인된 URL`, MS Azure는 `접근 공유 시그니처` 라고 부른다.
2. API 서버가 해당 URL을 내려준다.
3. 클라이언트는 받은 URL이 가리키는 위치에 비디오를 업로드 한다.

<br />

### 안전성 최적화 : 비디오 보호

비디오 원본 도난 우려 및 저작권을 보호하기 위해 다음 선택지를 채택할 수 있다.

1. 디지털 저작권 관리(DRM) 시스템 도입
2. AES 암호화
   - 비디오를 암호화하고 접근 권한을 설정하는 방식
   - 암호화된 비디오는 재생 시에만 복호화한다.
3. 워터마크

<br />

### 비용 최적화

연구 결과에 따르면 유튜브의 비디오 스트리밍은 _롱테일(long-tail)_ 분포를 따른다고 한다.

이를 기반하여 최적화를 시도할 수 있다.

1. 인기 있는 비디오는 CDN을 통해 재생, 나머지 비디오는 비디오 서버를 통해 재생한다.

2. 인기가 별로 없는 비디오는 인코딩 조차할 필요가 없을 수도 있다.

3. 짧은 비디오라면 필요할 때마다 인코딩

4. 어떤 비디오는 특정 지역에서만 인기가 높다. 이를 다른 모든 지역에 옮겨둘 필요는 없다.

<br />
<br />

## 오류 처리

시스템 오류에는 2가지 종류가 있다.

- 회복 가능 오류(recoverable error)

  비디오 트랜스코딩 실패와 같은 오류이다.

  몇번 재시도 하면 해결되는 경우가 많지만

  계속해서 실패하면 클라이언트에게 오류 코드를 반환해야 한다.

- 회복 불가능 오류(non-recoverable error)

  비디오 포맷이 잘못되었거나 하는 오류가 발생하면

  작업을 중단하고 클라이언트에게 적절한 오류 코드를 반환해야 한다.

<hr >

참고자료

- https://developer.mozilla.org/ko/docs/Web/API/Blob
- https://www.w3.org/TR/FileAPI/#dfn-blobParts
- https://velog.io/@broccolism/%ED%9A%A8%EC%9C%A8%EC%A0%81%EC%9D%B8-%EB%8F%99%EC%98%81%EC%83%81-%EC%97%85%EB%A1%9C%EB%93%9C%EB%A5%BC-%EC%9C%84%ED%95%9C-%EC%97%AC%EC%A0%95-%EB%8C%80%EA%B7%9C%EB%AA%A8-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EC%84%A4%EA%B3%84-%EA%B8%B0%EC%B4%88-14%EC%9E%A5
