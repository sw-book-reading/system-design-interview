# 13장 검색어 자동완성 시스템

## 만족해야 하는 요구사항

- 빠른 응답 속도

  100밀리초 이내에 검색어가 표시되어야 한다.

- 연관성

  사용자가 입력한 검색어와 연관된 검색어가 출력되어야 한다.

- 정렬

  인기도 등의 순위 모델에 의해 정렬되어 있어야 한다.

- 규모 확장성

  많은 트래픽을 감당할 수 있도록 확장 가능해야 한다.

- 고가용성

  시스템의 일부에 장애가 발생하거나, 느려지거나, 예쌍치 못한 네트워크 오류가 생겨도 시스템은 계속 사용가능 해야 한다.

<br />

## 개략적 설계안 제시 및 동의 구하기

개략적으로 시스템은 두 부분으로 나뉜다.

- 데이터 수집 서비스(data gathering service)

  사용자가 입력한 질의를 실시간으로 수집하는 서비스이다.

- 질의 서비스(query service)

  주어진 질의에 다섯 개의 인기 검색어를 정렬해 내놓는 서비스이다.

<br />

### 질의 서비스

아래와 같은 테이블이 있는 상태라고 가정하자.

- query : 질의문을 저장하는 컬럼
- frequency : 질의문이 사용된 빈도

| query     | frequency |
| --------- | --------- |
| twitter   | 35        |
| twitch    | 29        |
| twilight  | 25        |
| twin peak | 21        |

이 상태에서 사용자가 `tw` 를 검색한다고 하면

```sql
SELECT * FROM frequency_table
WHERE query LIKE `prefix%`
ORDER BY frequency DESC
LIMIT 5

```

위 방법은 데이터 양이 적을 때는 나쁘지 않은 설계이지만 데이터가 아주 많아지면 병목이 발생할 수 있다.

<br />

## 상세 설계

트라이 구조를 사용해 최적화해보자

### 트라이 자료 구조(trie)

- 트라이는 트리 형태의 자료구조
- 이 트리의 루트 노드는 빈 문자열을 나타낸다.
- 각 노드는 글자(character) 하나를 저장하며, 26개의 자식 노드(해당 글자 다음에 등장할 수 있는 모든 글자의 개수)를 가질 수 있다.
- 각 트리 노드는 하나의 단어, 또는 접두어 문자열(prefix string)을 나타낸다.

트라이 자료 구조를 활용해서 설계할 경우

1. 접두어의 최대 길이를 제한
2. 각 노드에 인기 검색어를 캐시

와 같은 최적화 기법을 통해 검색의 시간 복잡도를 O(1)으로 줄일 수 있다.

<br />

## 데이터 수집 서비스

데이터 수집 서비스의 역할은 위 트라이에 들어갈 데이터를 모으고 분석하는 것이다.

사용자가 검색어를 입력할 때마다 실시간으로 갱신되는 방법은 두 가지 이유때문에 실용적이지 못하다.

- 매일 수천만 건의 질의를 업데이트 치면 느려진다.
- 일단 트라이가 만들어지고 나면 인기 검색어는 그다지 자주 바뀌지 않을것이므로 자주 갱신할 필요가 없다.

실시간이 아닌 주기적으로 트라이를 갱신하는 방법

1. 사용자가 검색창에 입력하는 원본 데이터를 보관한다.
2. 로그 취합 서버에서 위 데이터를 취합한다.
3. 작업 서버에서 그 데이터를 보며 매주 트라이를 갱신한다.
4. 트라이 캐시 계층도 같이 갱신한다.

<br />

## 질의 서비스

데이터 수집 서비스가 만든 트라이에 실제로 검색 질의를 하는 서비스다.

질의 서비스는 번개처럼 빨라야 한다. 다음과 같은 최적화 기법을 살펴보자.

- AJAX 요청

  요청 날릴때마다 새로고침 발생하지 않음

- 브라우저 캐싱

  브라우저에 검색어 제안 결과를 캐싱해놓는 것.

  구글이 이 방식을 사용해서 1시간동안 캐시해놓는다.

- 데이터 샘플링

  모든 질의를 다 로깅하도록 하면 CPU 낭비가 심하므로 N개의 요청 중 1개만 로깅하도록 하는 기법

서버 뿐만 아니라 클라이언트에서도 최적화를 할 수 있다.

<br />

## 검색어 삭제

혐오,폭력적인 검색어를 추천 목록에서 거르기 위해 API 서버와 트라이 캐시 사이에 필터 계층을 둘 수 있다.
